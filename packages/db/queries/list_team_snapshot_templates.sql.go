// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: list_team_snapshot_templates.sql

package queries

import (
	"context"
	"time"

	"github.com/google/uuid"
)

const listTeamSnapshotTemplates = `-- name: ListTeamSnapshotTemplates :many
SELECT 
    e.id as snapshot_id,
    st.sandbox_id,
    e.created_at,
    e.team_id,
    eb.id as build_id,
    eb.vcpu,
    eb.ram_mb,
    eb.total_disk_size_mb,
    eb.envd_version,
    eb.kernel_version,
    eb.firecracker_version,
    eb.cluster_node_id,
    COALESCE(ea.aliases, ARRAY[]::text[])::text[] AS aliases
FROM "public"."envs" e
JOIN "public"."snapshot_templates" st ON st.env_id = e.id
JOIN LATERAL (
    SELECT b.id, b.created_at, b.updated_at, b.finished_at, b.status, b.dockerfile, b.start_cmd, b.vcpu, b.ram_mb, b.free_disk_size_mb, b.total_disk_size_mb, b.kernel_version, b.firecracker_version, b.env_id, b.envd_version, b.ready_cmd, b.cluster_node_id, b.reason, b.version, b.cpu_architecture, b.cpu_family, b.cpu_model, b.cpu_model_name, b.cpu_flags
    FROM "public"."env_build_assignments" ba
    JOIN "public"."env_builds" b ON b.id = ba.build_id
    WHERE ba.env_id = e.id AND ba.tag = 'default' AND b.status IN ('success', 'uploaded', 'ready')
    ORDER BY ba.created_at DESC
    LIMIT 1
) eb ON TRUE
LEFT JOIN LATERAL (
    SELECT ARRAY_AGG(alias ORDER BY alias) AS aliases
    FROM "public"."env_aliases"
    WHERE env_id = e.id
) ea ON TRUE
WHERE e.team_id = $1
AND e.source = 'snapshot_template'
AND (
    $2::text IS NULL 
    OR st.sandbox_id = $2::text
)
AND (e.created_at, e.id) < ($3, $4::text)
ORDER BY e.created_at DESC, e.id DESC
LIMIT $5
`

type ListTeamSnapshotTemplatesParams struct {
	TeamID     uuid.UUID
	SandboxID  *string
	CursorTime time.Time
	CursorID   string
	PageLimit  int32
}

type ListTeamSnapshotTemplatesRow struct {
	SnapshotID         string
	SandboxID          string
	CreatedAt          time.Time
	TeamID             uuid.UUID
	BuildID            uuid.UUID
	Vcpu               int64
	RamMb              int64
	TotalDiskSizeMb    *int64
	EnvdVersion        *string
	KernelVersion      string
	FirecrackerVersion string
	ClusterNodeID      *string
	Aliases            []string
}

// Lists all persistent snapshot templates for a team with cursor-based pagination.
// Snapshot templates are envs with source='snapshot_template'.
func (q *Queries) ListTeamSnapshotTemplates(ctx context.Context, arg ListTeamSnapshotTemplatesParams) ([]ListTeamSnapshotTemplatesRow, error) {
	rows, err := q.db.Query(ctx, listTeamSnapshotTemplates,
		arg.TeamID,
		arg.SandboxID,
		arg.CursorTime,
		arg.CursorID,
		arg.PageLimit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ListTeamSnapshotTemplatesRow
	for rows.Next() {
		var i ListTeamSnapshotTemplatesRow
		if err := rows.Scan(
			&i.SnapshotID,
			&i.SandboxID,
			&i.CreatedAt,
			&i.TeamID,
			&i.BuildID,
			&i.Vcpu,
			&i.RamMb,
			&i.TotalDiskSizeMb,
			&i.EnvdVersion,
			&i.KernelVersion,
			&i.FirecrackerVersion,
			&i.ClusterNodeID,
			&i.Aliases,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
