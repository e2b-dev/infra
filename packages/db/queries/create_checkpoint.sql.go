// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: create_checkpoint.sql

package queries

import (
	"context"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const createCheckpoint = `-- name: CreateCheckpoint :one
WITH get_snapshot AS (
    SELECT s.env_id as template_id
    FROM "public"."snapshots" s
    WHERE s.sandbox_id = $1
    AND s.team_id = $2
),

new_build AS (
    INSERT INTO "public"."env_builds" (
        env_id,
        vcpu,
        ram_mb,
        free_disk_size_mb,
        kernel_version,
        firecracker_version,
        envd_version,
        status,
        cluster_node_id,
        total_disk_size_mb,
        updated_at,
        cpu_architecture,
        cpu_family,
        cpu_model,
        cpu_model_name,
        cpu_flags
    ) VALUES (
        (SELECT template_id FROM get_snapshot),
        $3,
        $4,
        $5,
        $6,
        $7,
        $8,
        $9,
        $10,
        $11,
        now(),
        $12,
        $13,
        $14,
        $15,
        $16
    ) RETURNING id as build_id, env_id as template_id
),

build_assignment AS (
    INSERT INTO "public"."env_build_assignments" (env_id, build_id, tag)
    VALUES (
        (SELECT template_id FROM new_build),
        (SELECT build_id FROM new_build),
        $17
    )
    RETURNING build_id, env_id as template_id, created_at
)

SELECT build_id, template_id, created_at FROM build_assignment
`

type CreateCheckpointParams struct {
	SandboxID          string
	TeamID             uuid.UUID
	Vcpu               int64
	RamMb              int64
	FreeDiskSizeMb     int64
	KernelVersion      string
	FirecrackerVersion string
	EnvdVersion        *string
	Status             string
	OriginNodeID       *string
	TotalDiskSizeMb    *int64
	CpuArchitecture    *string
	CpuFamily          *string
	CpuModel           *string
	CpuModelName       *string
	CpuFlags           []string
	Tag                string
}

type CreateCheckpointRow struct {
	BuildID    uuid.UUID
	TemplateID string
	CreatedAt  pgtype.Timestamptz
}

// Creates a checkpoint for a sandbox by creating a new env_build and assignment with a named tag.
// The sandbox must already have an env (template) from a previous pause operation.
// Returns the build_id (checkpoint ID) and template_id.
func (q *Queries) CreateCheckpoint(ctx context.Context, arg CreateCheckpointParams) (CreateCheckpointRow, error) {
	row := q.db.QueryRow(ctx, createCheckpoint,
		arg.SandboxID,
		arg.TeamID,
		arg.Vcpu,
		arg.RamMb,
		arg.FreeDiskSizeMb,
		arg.KernelVersion,
		arg.FirecrackerVersion,
		arg.EnvdVersion,
		arg.Status,
		arg.OriginNodeID,
		arg.TotalDiskSizeMb,
		arg.CpuArchitecture,
		arg.CpuFamily,
		arg.CpuModel,
		arg.CpuModelName,
		arg.CpuFlags,
		arg.Tag,
	)
	var i CreateCheckpointRow
	err := row.Scan(&i.BuildID, &i.TemplateID, &i.CreatedAt)
	return i, err
}
