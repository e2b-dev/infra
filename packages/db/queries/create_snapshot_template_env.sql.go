// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: create_snapshot_template_env.sql

package queries

import (
	"context"

	"github.com/google/uuid"
)

const createSnapshotTemplateEnv = `-- name: CreateSnapshotTemplateEnv :one
WITH new_env AS (
    INSERT INTO "public"."envs" (id, public, created_by, team_id, updated_at, source)
    VALUES ($1, FALSE, NULL, $2, now(), 'snapshot_template')
    RETURNING id
),

snapshot_template AS (
    INSERT INTO "public"."snapshot_templates" (env_id, sandbox_id)
    VALUES (
        (SELECT id FROM new_env),
        $3
    )
),

build_assignment AS (
    INSERT INTO "public"."env_build_assignments" (env_id, build_id, tag)
    VALUES (
        (SELECT id FROM new_env),
        $4,
        $5
    )
    RETURNING env_id as snapshot_id
)

SELECT snapshot_id FROM build_assignment
`

type CreateSnapshotTemplateEnvParams struct {
	SnapshotID string
	TeamID     uuid.UUID
	SandboxID  string
	BuildID    uuid.UUID
	Tag        string
}

// Creates a snapshot_template env entry with source='snapshot_template' and links it to an existing build
// This is used after UpsertSnapshot to create a persistent snapshot template
func (q *Queries) CreateSnapshotTemplateEnv(ctx context.Context, arg CreateSnapshotTemplateEnvParams) (string, error) {
	row := q.db.QueryRow(ctx, createSnapshotTemplateEnv,
		arg.SnapshotID,
		arg.TeamID,
		arg.SandboxID,
		arg.BuildID,
		arg.Tag,
	)
	var snapshot_id string
	err := row.Scan(&snapshot_id)
	return snapshot_id, err
}
