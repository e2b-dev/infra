// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: create_new_snapshot.sql

package queries

import (
	"context"

	"github.com/e2b-dev/infra/packages/db/pkg/types"
	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const upsertSnapshot = `-- name: UpsertSnapshot :one
WITH new_template AS (
    INSERT INTO "public"."envs" (id, public, created_by, team_id, updated_at)
    SELECT $1, FALSE, NULL, $2, now()
    WHERE NOT EXISTS (
        SELECT id
        FROM "public"."snapshots" s
        WHERE s.sandbox_id = $3
    ) RETURNING id
),

snapshot as (
    INSERT INTO "public"."snapshots" (
       sandbox_id,
       base_env_id,
       team_id,
       env_id,
       metadata,
       sandbox_started_at,
       env_secure,
       allow_internet_access,
       origin_node_id,
       auto_pause,
       config
    )
    VALUES (
            $3,
            $4,
            $2,
            -- If snapshot already exists, new_template id will be null, env_id can't be null, so use placeholder ''
            COALESCE((SELECT id FROM new_template), ''),
            $5,
            $6,
            $7,
            $8,
            $9,
            $10,
            $11
   )
    ON CONFLICT (sandbox_id) DO UPDATE SET
        metadata = excluded.metadata,
        sandbox_started_at = excluded.sandbox_started_at,
        origin_node_id = excluded.origin_node_id,
        auto_pause = excluded.auto_pause,
        config = excluded.config
    RETURNING env_id as template_id
),

new_build as (
    INSERT INTO "public"."env_builds" (
        env_id,
        vcpu,
        ram_mb,
        free_disk_size_mb,
        kernel_version,
        firecracker_version,
        envd_version,
        status,
        cluster_node_id,
        total_disk_size_mb,
        updated_at,
        cpu_architecture,
        cpu_family,
        cpu_model,
        cpu_model_name,
        cpu_flags
    ) VALUES (
        (SELECT template_id FROM snapshot),
        $12,
        $13,
        $14,
        $15,
        $16,
        $17,
        $18,
        $9,
        $19,
        now(),
        $20,
        $21,
        $22,
        $23,
        $24
    ) RETURNING id as build_id, env_id as template_id
),

build_assignment as (
    INSERT INTO "public"."env_build_assignments" (env_id, build_id, tag)
    VALUES (
        (SELECT template_id FROM new_build),
        (SELECT build_id FROM new_build),
        'default'
    )
    RETURNING build_id, env_id as template_id
)

SELECT build_id, template_id FROM new_build
`

type UpsertSnapshotParams struct {
	TemplateID          string
	TeamID              uuid.UUID
	SandboxID           string
	BaseTemplateID      string
	Metadata            types.JSONBStringMap
	StartedAt           pgtype.Timestamptz
	Secure              bool
	AllowInternetAccess *bool
	OriginNodeID        string
	AutoPause           bool
	Config              *types.PausedSandboxConfig
	Vcpu                int64
	RamMb               int64
	FreeDiskSizeMb      int64
	KernelVersion       string
	FirecrackerVersion  string
	EnvdVersion         *string
	Status              string
	TotalDiskSizeMb     *int64
	CpuArchitecture     *string
	CpuFamily           *string
	CpuModel            *string
	CpuModelName        *string
	CpuFlags            []string
}

type UpsertSnapshotRow struct {
	BuildID    uuid.UUID
	TemplateID string
}

// Create a new snapshot or update an existing one
// Create a new build for the snapshot
// Create the build assignment edge (explicit, not relying on trigger)
func (q *Queries) UpsertSnapshot(ctx context.Context, arg UpsertSnapshotParams) (UpsertSnapshotRow, error) {
	row := q.db.QueryRow(ctx, upsertSnapshot,
		arg.TemplateID,
		arg.TeamID,
		arg.SandboxID,
		arg.BaseTemplateID,
		arg.Metadata,
		arg.StartedAt,
		arg.Secure,
		arg.AllowInternetAccess,
		arg.OriginNodeID,
		arg.AutoPause,
		arg.Config,
		arg.Vcpu,
		arg.RamMb,
		arg.FreeDiskSizeMb,
		arg.KernelVersion,
		arg.FirecrackerVersion,
		arg.EnvdVersion,
		arg.Status,
		arg.TotalDiskSizeMb,
		arg.CpuArchitecture,
		arg.CpuFamily,
		arg.CpuModel,
		arg.CpuModelName,
		arg.CpuFlags,
	)
	var i UpsertSnapshotRow
	err := row.Scan(&i.BuildID, &i.TemplateID)
	return i, err
}
