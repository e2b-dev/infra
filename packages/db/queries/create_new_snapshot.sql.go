// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: create_new_snapshot.sql

package queries

import (
	"context"

	"github.com/e2b-dev/infra/packages/db/types"
	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const upsertSnapshot = `-- name: UpsertSnapshot :one
WITH new_template AS (
    INSERT INTO "public"."envs" (id, public, created_by, team_id, updated_at)
    SELECT $10, FALSE, NULL, $11, now()
    WHERE NOT EXISTS (
        SELECT id
        FROM "public"."snapshots" s
        WHERE s.sandbox_id = $12
    ) RETURNING id
),

snapshot as (
    INSERT INTO "public"."snapshots" (
       sandbox_id,
       base_env_id,
       team_id,
       env_id,
       metadata,
       sandbox_started_at,
       env_secure,
       allow_internet_access,
       origin_node_id,
       auto_pause,
       config
    )
    VALUES (
            $12,
            $13,
            $11,
            -- If snapshot already exists, new_template id will be null, env_id can't be null, so use placeholder ''
            COALESCE((SELECT id FROM new_template), ''),
            $14,
            $15,
            $16,
            $17,
            $8,
            $18,
            $19
   )
    ON CONFLICT (sandbox_id) DO UPDATE SET
        metadata = $14,
        sandbox_started_at = $15,
        origin_node_id = $8,
        auto_pause = $18,
        config = $19
    RETURNING env_id as template_id
)

INSERT INTO "public"."env_builds" (
    env_id,
    vcpu,
    ram_mb,
    free_disk_size_mb,
    kernel_version,
    firecracker_version,
    envd_version,
    status,
    cluster_node_id,
    total_disk_size_mb,
    updated_at
) VALUES (
    (SELECT template_id FROM snapshot),
    $1,
    $2,
    $3,
    $4,
    $5,
    $6,
    $7,
    $8,
    $9,
    now()
) RETURNING id as build_id, env_id as template_id
`

type UpsertSnapshotParams struct {
	Vcpu                int64
	RamMb               int64
	FreeDiskSizeMb      int64
	KernelVersion       string
	FirecrackerVersion  string
	EnvdVersion         *string
	Status              string
	OriginNodeID        string
	TotalDiskSizeMb     *int64
	TemplateID          string
	TeamID              uuid.UUID
	SandboxID           string
	BaseTemplateID      string
	Metadata            types.JSONBStringMap
	StartedAt           pgtype.Timestamptz
	Secure              bool
	AllowInternetAccess *bool
	AutoPause           bool
	Config              *types.PausedSandboxConfig
}

type UpsertSnapshotRow struct {
	BuildID    uuid.UUID
	TemplateID string
}

// Create a new snapshot or update an existing one
// Create a new build for the snapshot
func (q *Queries) UpsertSnapshot(ctx context.Context, arg UpsertSnapshotParams) (UpsertSnapshotRow, error) {
	row := q.db.QueryRow(ctx, upsertSnapshot,
		arg.Vcpu,
		arg.RamMb,
		arg.FreeDiskSizeMb,
		arg.KernelVersion,
		arg.FirecrackerVersion,
		arg.EnvdVersion,
		arg.Status,
		arg.OriginNodeID,
		arg.TotalDiskSizeMb,
		arg.TemplateID,
		arg.TeamID,
		arg.SandboxID,
		arg.BaseTemplateID,
		arg.Metadata,
		arg.StartedAt,
		arg.Secure,
		arg.AllowInternetAccess,
		arg.AutoPause,
		arg.Config,
	)
	var i UpsertSnapshotRow
	err := row.Scan(&i.BuildID, &i.TemplateID)
	return i, err
}
