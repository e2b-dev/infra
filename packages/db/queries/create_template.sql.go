// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: create_template.sql

package queries

import (
	"context"

	"github.com/e2b-dev/infra/packages/db/pkg/types"
	"github.com/google/uuid"
)

const createOrUpdateTemplate = `-- name: CreateOrUpdateTemplate :exec
INSERT INTO "public"."envs"(id, team_id, created_by, updated_at, public, cluster_id, source)
VALUES ($1, $2, $3, NOW(), FALSE, $4, 'template')
ON CONFLICT (id) DO UPDATE
SET updated_at  = NOW(),
    build_count = envs.build_count + 1
`

type CreateOrUpdateTemplateParams struct {
	TemplateID string
	TeamID     uuid.UUID
	CreatedBy  *uuid.UUID
	ClusterID  *uuid.UUID
}

func (q *Queries) CreateOrUpdateTemplate(ctx context.Context, arg CreateOrUpdateTemplateParams) error {
	_, err := q.db.Exec(ctx, createOrUpdateTemplate,
		arg.TemplateID,
		arg.TeamID,
		arg.CreatedBy,
		arg.ClusterID,
	)
	return err
}

const createTemplateBuild = `-- name: CreateTemplateBuild :exec
INSERT INTO "public"."env_builds" (
    id,
    updated_at,
    status,
    ram_mb,
    vcpu,
    kernel_version,
    firecracker_version,
    free_disk_size_mb,
    start_cmd,
    ready_cmd,
    dockerfile,
    version
) VALUES (
    $1,
    NOW(),
    $2,
    $3,
    $4,
    $5,
    $6,
    $7,
    $8,
    $9,
    $10,
    $11
)
`

type CreateTemplateBuildParams struct {
	BuildID            uuid.UUID
	Status             types.BuildStatus
	RamMb              int64
	Vcpu               int64
	KernelVersion      string
	FirecrackerVersion string
	FreeDiskSizeMb     int64
	StartCmd           *string
	ReadyCmd           *string
	Dockerfile         *string
	Version            *string
}

func (q *Queries) CreateTemplateBuild(ctx context.Context, arg CreateTemplateBuildParams) error {
	_, err := q.db.Exec(ctx, createTemplateBuild,
		arg.BuildID,
		arg.Status,
		arg.RamMb,
		arg.Vcpu,
		arg.KernelVersion,
		arg.FirecrackerVersion,
		arg.FreeDiskSizeMb,
		arg.StartCmd,
		arg.ReadyCmd,
		arg.Dockerfile,
		arg.Version,
	)
	return err
}

const invalidateUnstartedTemplateBuilds = `-- name: InvalidateUnstartedTemplateBuilds :exec
UPDATE "public"."env_builds" eb
SET status = 'failed',
    reason = $1,
    updated_at = NOW(),
    finished_at = NOW()
FROM "public"."env_build_assignments" eba
WHERE eba.build_id = eb.id
    AND eba.env_id = $2
    AND eba.tag = ANY($3::text[])
    AND eb.status IN ('waiting', 'pending')
`

type InvalidateUnstartedTemplateBuildsParams struct {
	Reason     types.BuildReason
	TemplateID string
	Tags       []string
}

func (q *Queries) InvalidateUnstartedTemplateBuilds(ctx context.Context, arg InvalidateUnstartedTemplateBuildsParams) error {
	_, err := q.db.Exec(ctx, invalidateUnstartedTemplateBuilds, arg.Reason, arg.TemplateID, arg.Tags)
	return err
}
