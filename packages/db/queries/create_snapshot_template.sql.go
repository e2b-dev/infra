// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: create_snapshot_template.sql

package queries

import (
	"context"

	"github.com/google/uuid"
)

const createSnapshotTemplate = `-- name: CreateSnapshotTemplate :one
WITH new_template AS (
    INSERT INTO "public"."envs" (id, public, created_by, team_id, updated_at, source, source_sandbox_id)
    VALUES ($1, FALSE, $2, $3, now(), 'snapshot', $4)
    RETURNING id
),

new_build AS (
    INSERT INTO "public"."env_builds" (
        env_id,
        vcpu,
        ram_mb,
        free_disk_size_mb,
        kernel_version,
        firecracker_version,
        envd_version,
        status,
        cluster_node_id,
        total_disk_size_mb,
        updated_at,
        cpu_architecture,
        cpu_family,
        cpu_model,
        cpu_model_name,
        cpu_flags
    ) VALUES (
        (SELECT id FROM new_template),
        $5,
        $6,
        $7,
        $8,
        $9,
        $10,
        $11,
        $12,
        $13,
        now(),
        $14,
        $15,
        $16,
        $17,
        $18
    ) RETURNING id as build_id, env_id as snapshot_id
),

build_assignment AS (
    INSERT INTO "public"."env_build_assignments" (env_id, build_id, tag)
    VALUES (
        (SELECT snapshot_id FROM new_build),
        (SELECT build_id FROM new_build),
        'default'
    )
    RETURNING build_id, env_id as snapshot_id
)

SELECT snapshot_id, build_id FROM new_build
`

type CreateSnapshotTemplateParams struct {
	SnapshotID         string
	CreatedBy          *uuid.UUID
	TeamID             uuid.UUID
	SourceSandboxID    *string
	Vcpu               int64
	RamMb              int64
	FreeDiskSizeMb     int64
	KernelVersion      string
	FirecrackerVersion string
	EnvdVersion        *string
	Status             string
	OriginNodeID       *string
	TotalDiskSizeMb    *int64
	CpuArchitecture    *string
	CpuFamily          *string
	CpuModel           *string
	CpuModelName       *string
	CpuFlags           []string
}

type CreateSnapshotTemplateRow struct {
	SnapshotID string
	BuildID    uuid.UUID
}

// Creates a persistent snapshot as a new template with source='snapshot'.
// This is different from the pause/resume snapshot which lives in the snapshots table.
// Returns the snapshot_id (template ID) and build_id.
func (q *Queries) CreateSnapshotTemplate(ctx context.Context, arg CreateSnapshotTemplateParams) (CreateSnapshotTemplateRow, error) {
	row := q.db.QueryRow(ctx, createSnapshotTemplate,
		arg.SnapshotID,
		arg.CreatedBy,
		arg.TeamID,
		arg.SourceSandboxID,
		arg.Vcpu,
		arg.RamMb,
		arg.FreeDiskSizeMb,
		arg.KernelVersion,
		arg.FirecrackerVersion,
		arg.EnvdVersion,
		arg.Status,
		arg.OriginNodeID,
		arg.TotalDiskSizeMb,
		arg.CpuArchitecture,
		arg.CpuFamily,
		arg.CpuModel,
		arg.CpuModelName,
		arg.CpuFlags,
	)
	var i CreateSnapshotTemplateRow
	err := row.Scan(&i.SnapshotID, &i.BuildID)
	return i, err
}
