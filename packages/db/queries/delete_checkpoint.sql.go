// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: delete_checkpoint.sql

package queries

import (
	"context"

	"github.com/google/uuid"
)

const deleteCheckpoint = `-- name: DeleteCheckpoint :exec
WITH valid_checkpoint AS (
    SELECT eba.build_id, eba.id as assignment_id
    FROM "public"."env_build_assignments" eba
    JOIN "public"."snapshots" s ON s.env_id = eba.env_id
    WHERE eba.build_id = $1
    AND s.sandbox_id = $2
    AND s.team_id = $3
    AND eba.tag != 'default'
),

delete_assignment AS (
    DELETE FROM "public"."env_build_assignments"
    WHERE id = (SELECT assignment_id FROM valid_checkpoint)
)

DELETE FROM "public"."env_builds"
WHERE id = (SELECT build_id FROM valid_checkpoint)
`

type DeleteCheckpointParams struct {
	CheckpointID uuid.UUID
	SandboxID    string
	TeamID       uuid.UUID
}

// Deletes a checkpoint by removing its build assignment and the build itself.
// Validates that the checkpoint belongs to the specified sandbox and team.
func (q *Queries) DeleteCheckpoint(ctx context.Context, arg DeleteCheckpointParams) error {
	_, err := q.db.Exec(ctx, deleteCheckpoint, arg.CheckpointID, arg.SandboxID, arg.TeamID)
	return err
}
