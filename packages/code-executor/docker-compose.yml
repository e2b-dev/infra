services:
  piston:
    image: ghcr.io/engineer-man/piston:latest
    container_name: piston-ainosov
    ports:
      - "2000:2000"
    volumes:
      - piston-data:/piston
      - /sys/fs/cgroup/unified:/sys/fs/cgroup:rw
    tmpfs:
      - /tmp
      - /run
      - /var/run
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Создаём все необходимые директории заранее
        mkdir -p /piston/isolate /piston/tmp /piston/logs || true
        chmod -R 777 /piston/isolate /piston/tmp /piston/logs || true
        # Инициализируем cgroup вручную перед запуском entrypoint
        cd /sys/fs/cgroup || exit 1
        mkdir -p isolate || true
        if [ -f isolate/cgroup.procs ] && [ -w isolate/cgroup.procs ]; then
          echo 1 > isolate/cgroup.procs 2>/dev/null || true
        fi
        echo '+cpuset +cpu +io +memory +pids' > cgroup.subtree_control 2>/dev/null || true
        cd isolate || exit 1
        mkdir -p init || true
        if [ -f init/cgroup.procs ] && [ -w init/cgroup.procs ]; then
          echo 1 > init/cgroup.procs 2>/dev/null || true
        fi
        echo '+cpuset +memory' > cgroup.subtree_control 2>/dev/null || true
        echo "Initialized cgroup"
        chown -R piston:piston /piston || true
        # Запускаем приложение напрямую, пропуская entrypoint скрипт
        exec su -- piston -c 'ulimit -n 65536 && node /piston_api/src'
    init: true
    environment:
      - PISTON_SKIP_CGROUP_CHECK=true
    privileged: true
    user: root
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:2000/api/v2/runtimes', (r) => process.exit(r.statusCode === 200 ? 0 : 1))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - code-executor-network

  piston-install-languages:
    image: alpine:latest
    container_name: piston-install-languages-ainosov
    volumes:
      - ./install-all-languages.sh:/install-all-languages.sh:ro
    environment:
      - PISTON_URL=http://piston:2000
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache curl jq bash
        /bin/bash /install-all-languages.sh
    depends_on:
      piston:
        condition: service_healthy
    networks:
      - code-executor-network
    restart: "no"
    user: root

  code-executor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: code-executor-ainosov
    ports:
      - "8081:8080"
    environment:
      - PISTON_URL=http://piston:2000
    command:
      [
        "code-executor",
        "--port",
        "8080",
        "--workers",
        "10",
        "--piston-url",
        "http://piston:2000",
      ]
    depends_on:
      piston:
        condition: service_healthy
      piston-install-languages:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - code-executor-network

volumes:
  piston-data:

networks:
  code-executor-network:
    driver: bridge
