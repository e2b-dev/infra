openapi: 3.0.0
info:
  version: 0.1.0
  title: E2B Edge API

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  responses:
    "400":
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "401":
      description: Authentication error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "404":
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "409":
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "500":
      description: Server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    ClusterNodeInfo:
      required:
        - nodeID
        - serviceInstanceID
        - serviceVersion
        - serviceVersionCommit
        - serviceStartup
        - serviceStatus
      properties:
        nodeID:
          type: string
          description: Node ID
        serviceInstanceID:
          type: string
          description: Service ID
        serviceVersion:
          type: string
          description: Version of the service
        serviceVersionCommit:
          type: string
          description: Version of the service
        serviceStartup:
          type: string
          format: date-time
          description: Time when the node started
        serviceStatus:
          $ref: "#/components/schemas/ClusterNodeStatus"

    ClusterNodeStatus:
      type: string
      description: State of the cluster node
      enum:
        - healthy
        - draining
        - unhealthy

    ClusterOrchestratorRole:
      type: string
      description: Capability of the orchestrator
      enum:
        - orchestrator
        - template-builder

    ClusterServiceDiscovery:
      required:
        - orchestrators
      properties:
        orchestrators:
          type: array
          items:
            $ref: "#/components/schemas/ClusterOrchestratorNode"

    ClusterOrchestratorNode:
      required:
        - nodeID
        - serviceInstanceID
        - serviceVersion
        - serviceVersionCommit
        - serviceStartedAt
        - serviceHost
        - serviceStatus
        - roles

      properties:
        nodeID:
          type: string
          description: Node ID
        serviceInstanceID:
          type: string
          description: Service instance ID
        serviceVersion:
          type: string
          description: Service Version
        serviceVersionCommit:
          type: string
          description: Service Version
        serviceHost:
          type: string
          description: Node private host address and service port
        serviceStartedAt:
          type: string
          format: date-time
          description: Time when the node was registered
        serviceStatus:
          $ref: "#/components/schemas/ClusterNodeStatus"
        roles:
          type: array
          items:
            $ref: "#/components/schemas/ClusterOrchestratorRole"

    Error:
      required:
        - code
        - message
      properties:
        code:
          type: integer
          format: int32
          description: Error code
        message:
          type: string
          description: Error

    LogLevel:
      type: string
      description: State of the sandbox
      enum:
        - debug
        - info
        - warn
        - error

    BuildLogEntry:
      required:
        - timestamp
        - message
        - level
        - fields
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the log entry
        message:
          type: string
          description: Log message content
        level:
          $ref: "#/components/schemas/LogLevel"
        fields:
          type: object
          additionalProperties:
            type: string
            description: Additional fields for the log entry

    SandboxLog:
      description: Log entry with timestamp and line
      required:
        - timestamp
        - line
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the log entry
        line:
          type: string
          description: Log line content

    SandboxLogEntry:
      required:
        - timestamp
        - level
        - message
        - fields
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the log entry
        message:
          type: string
          description: Log message content
        level:
          $ref: "#/components/schemas/LogLevel"
        fields:
          type: object
          additionalProperties:
            type: string

    TemplateBuildLogsResponse:
      required:
        - logEntries
      properties:
        logEntries:
          default: []
          description: Build logs structured
          type: array
          items:
            $ref: "#/components/schemas/BuildLogEntry"

    SandboxLogsResponse:
      required:
        - logs
        - logEntries
      properties:
        logs:
          default: []
          description: Sandbox logs
          type: array
          items:
            $ref: "#/components/schemas/SandboxLog"
        logEntries:
          description: Structured logs of the sandbox
          type: array
          items:
            $ref: "#/components/schemas/SandboxLogEntry"

    Timestamp:
      type: string
      format: date-time

    SandboxMetric:
      type: object
      required:
        - timestamp
        - timestamp_unix
        - cpu_used_pct
        - cpu_count
        - mem_total
        - mem_used
        - disk_total
        - disk_used
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the metric
        timestamp_unix:
          type: integer
          format: int64
          description: Unix timestamp in seconds
        cpu_used_pct:
          type: number
          format: float
          description: CPU usage percentage
        cpu_count:
          type: integer
          format: int32
          description: Number of CPUs
        mem_total:
          type: integer
          format: int64
          description: Total memory in bytes
        mem_used:
          type: integer
          format: int64
          description: Used memory in bytes
        disk_total:
          type: integer
          format: int64
          description: Total disk space in bytes
        disk_used:
          type: integer
          format: int64
          description: Used disk space in bytes

    SandboxesWithMetrics:
      type: object
      required:
        - sandboxes
      properties:
        sandboxes:
          type: object
          description: Map of sandbox IDs to their latest metrics
          additionalProperties:
            $ref: "#/components/schemas/SandboxMetric"
tags:
  - name: service-discovery
  - name: sandboxes

paths:
  /health:
    get:
      operationId: healthCheck
      description: Health check
      responses:
        "200":
          description: Request was successful

  /health/machine:
    get:
      operationId: healthCheckMachine
      description: Health check for machine status
      responses:
        "200":
          description: Request was successful

  /v1/info:
    get:
      operationId: v1Info
      description: Edge service information
      responses:
        "200":
          description: Successfully returned node information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClusterNodeInfo"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"

  # todo: remove deprecated endpoint when all APIs are redeployed (https://linear.app/e2b/issue/ENG-3464)
  /v1/service-discovery/nodes/orchestrators:
    get:
      operationId: v1ServiceDiscoveryGetOrchestrators
      description: Deprecated way how to get the orchestrators, use v2 endpoint instead.
      deprecated: true
      security:
        - ApiKeyAuth: []
      tags: [service-discovery]
      responses:
        "200":
          description: Successfully returned all orchestrators
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ClusterOrchestratorNode"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"

  /v1/service-discovery:
    get:
      operationId: v1ServiceDiscovery
      summary: Get the service discovery information
      security:
        - ApiKeyAuth: []
      tags: [service-discovery]
      responses:
        "200":
          description: Successfully returned all orchestrators
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClusterServiceDiscovery"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"

  /v1/sandboxes/{sandboxID}/logs:
    get:
      operationId: v1SandboxLogs
      summary: List structured sandbox logs
      security:
        - ApiKeyAuth: []
      tags: [sandboxes]
      parameters:
        - name: sandboxID
          in: path
          required: true
          schema:
            type: string
        - in: query
          name: teamID
          required: true
          schema:
            type: string
        - in: query
          name: start
          schema:
            type: integer
            format: int64
            minimum: 0
          description: Starting timestamp of the logs that should be returned in milliseconds
        - in: query
          name: limit
          schema:
            default: 1000
            format: int32
            minimum: 0
            type: integer
          description: Maximum number of logs that should be returned
      responses:
        "200":
          description: Successfully returned the sandbox logs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SandboxLogsResponse"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"

  /v1/sandboxes/{sandboxID}/metrics:
    get:
      operationId: v1SandboxMetrics
      summary: Get time-series metrics for a sandbox
      security:
        - ApiKeyAuth: []
      tags: [sandboxes]
      parameters:
        - name: sandboxID
          in: path
          required: true
          schema:
            type: string
          description: Sandbox ID
        - name: teamID
          in: query
          required: true
          schema:
            type: string
          description: Team ID that owns the sandbox
        - name: start
          in: query
          required: false
          schema:
            type: integer
            format: int64
          description: Start time in Unix seconds
        - name: end
          in: query
          required: false
          schema:
            type: integer
            format: int64
          description: End time in Unix seconds
      responses:
        "200":
          description: Successfully returned sandbox metrics
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SandboxMetric"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"

  /v1/sandboxes/metrics:
    get:
      operationId: v1SandboxesMetrics
      summary: Get latest metrics for multiple sandboxes
      security:
        - ApiKeyAuth: []
      tags: [sandboxes]
      parameters:
        - name: teamID
          in: query
          required: true
          schema:
            type: string
          description: Team ID that owns the sandboxes
        - name: sandbox_ids
          in: query
          required: true
          schema:
            type: array
            items:
              type: string
          description: List of sandbox IDs (max 100)
      responses:
        "200":
          description: Successfully returned sandboxes with metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SandboxesWithMetrics"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"

  /v1/templates/builds/{buildID}/logs:
    get:
      operationId: v1TemplateBuildLogs
      summary: Template build logs
      security:
        - ApiKeyAuth: []
      tags: [templates]
      parameters:
        - name: buildID
          in: path
          required: true
          schema:
            type: string
        - in: query
          name: orchestratorID
          required: false
          deprecated: true
          schema:
            type: string
        - in: query
          name: templateID
          required: true
          schema:
            type: string
        - in: query
          name: offset
          schema:
            default: 0
            type: integer
            format: int32
            minimum: 0
          description: Index of the starting build log that should be returned with the template
        - in: query
          name: start
          schema:
            type: integer
            format: int64
            minimum: 0
          description: Starting timestamp of the logs that should be returned in milliseconds
        - in: query
          name: end
          schema:
            type: integer
            format: int64
            minimum: 0
          description: Ending timestamp of the logs that should be returned in milliseconds
        - in: query
          name: limit
          schema:
            default: 100
            type: integer
            format: int32
            minimum: 0
            maximum: 100
          description: Maximum number of logs that should be returned
        - in: query
          name: direction
          schema:
            type: string
            enum:
              - forward
              - backward
            description: Direction of the logs that should be returned
        - in: query
          name: level
          schema:
            $ref: "#/components/schemas/LogLevel"
      responses:
        "200":
          description: Successfully returned the template build logs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TemplateBuildLogsResponse"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "500":
          $ref: "#/components/responses/500"
