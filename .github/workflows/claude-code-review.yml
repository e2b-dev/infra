name: Claude Code Review

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    name: Claude Code Review

    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request != null && 
       contains(github.event.comment.body, '@claude review') &&
       (github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout PR head commit
        id: pr-sha
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get PR head SHA
        id: pr-sha
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=${{ github.event.issue.number }}
            HEAD_SHA=$(gh pr view $PR_NUMBER --json headRefOid -q .headRefOid)
            echo "sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            Please review this pull request and provide feedback on:
            - Potential bugs or issues
            - Performance considerations
            - Important security concerns

            Be constructive and helpful in your feedback and be **very conscise**.
            Skip general recommendations, skip summarizing the changes, and don't make any recommendations on code style.
            Also skip any summarization about why the PR was done well, focus only on the code changes and the potential issues.
            Don't output final summaries, or final lists of action items.
            Reduce false positivesâ€”try to validate if the issue is really a valid problem in the changes.

            When you find a *specific issue* in the code (bug, performance concern, security risk, etc.),
            leave an **inline comment** on that exact file and line.  
            If no issues are found, do not post anything.

            To comment inline, use this format exactly (MUST be a single line, no backslashes or line breaks):

            ```bash
            gh api --method POST -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number || github.event.issue.number }}/comments -f body='${BODY}' -f commit_id="${{ steps.pr-sha.outputs.sha }}" -f path='${PATH}' -F line='${LINE}' -f side="RIGHT"
            ```

            IMPORTANT: 
            - The command MUST be on a single line with no backslashes (\\) or line breaks
            - Use single quotes around body, path, and line to prevent shell expansion (prevents command injection)
            - If the body or path contains a single quote ('), escape it by replacing ' with '\'' (this breaks out of the single-quoted string, adds a literal quote, and continues)
            - Example: if body is "It's a bug", use: body='It'\''s a bug'

          claude_args: '--allowed-tools "Bash(gh api:*), Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
